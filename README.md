# 결제기능

## 1. 아임포트 정기결제 테스트

### 사용

- nodejs
- react
- iamport API

### 결제로직

- 이니시스 결제를 사용했다.
- 이니시스 경우 첫결제에 빌링키를 발급받는데, 이 빌링키 결제금액이 0원이 아닐경우 실제 결제된 것처럼 결과가 넘어온다.
- 결제된 것처럼 이라는건, 실제 금액은 빠져나가지 않지만 만약 웹훅을 사용한다면 결제 금액이 빠져나간 결제와 같은 결과로 넘어오기 때문에 따로 필터링을 해주지 않으면 DB에 결제 정보가 저장될 수 있다. + 빌링키 발급 결제 역시 예약결제로 등록된다.
- 그럼 빌링키 발급 결제를 0원으로하면 되는것 아닌가? 그러면 이용자가 결제를 누르면 0원으로 나타나기 때문에 결제과정에서 혼란을 초래할 수 있음
- 그래서, 빌링키 발급시 merchant_uid or name을 빌링키 발급요이라는 것을 기입해서, 결제 중간에 필터를 걸어줘야 한다.
- 그래야 DB관리, 예약관리에 문제가 생기지 않는다.(생길수도 있지만...? 생긴다면 그때 또 해결하는 걸로)

```md
결제
빌링키발급 -> (POST /subscribe/payments/again)-> Webhook -> 빌링키 발급
빌링키 발급되면 실제결제(파는 상품 결제, 실제 돈이 나가는 결제)가 진행 -> POST /subscribe/payments/again -> webbook
(결제 완료되면) 결제 정보 저장
다음 결제 예약

+ @  (중간중간 실패에 대한 처리를 해줘야함/ 카드사용기간 만료, 카드 금액부족  등 => 물론 메세지로 넘어옴)

결제 취소의 경우 customer_uid가 필요
/subscribe/payments/unschedule/{customer_uid}
```

### 취소로직

- 버튼을 누르면, 결제된 리스트를 확인한다.
- 일단 취소 신청이 된게 있는지 확인
- 취소 신청이 된게 있으면 오늘날짜와 다음 결제 날짜를 비교
- 그리고 다음 결제 날짜가 오늘 날짜륿 넘어가면 ? 권한을 바꿔줌 + 권한 처리된 날짜를 기록
- 편한건 서버가 자동으로 처리되길 원하지만, 일단 위험이 있으니까 하넙ㄴ 거쳐가는걸로
- 그 뒤로는 고객관리 영역. 고객 가입 및 탈퇴 날의 흐름을 파악해서 서비스를 제공할 수 있을거라 생각된다.
- 뭐 예를들면, 이달의 결제 멤버 수 + 이달의 취소멤버 수 => 일종의 데쉬보드 같은거지

### 출처

[연동메뉴얼](https://docs.iamport.kr/)
[아임포트 API](https://api.iamport.kr/)

## 2. 아임포트 일반결제

## 3. 아임포트-카카오 결제

카카오 페이 추가. 테스트는 가능하지만 실제 결제로  쓰려면 심사가 필요. 하는 방법은 일반결제 부분과 동일

## 4. 아임포트-네이버 결제
