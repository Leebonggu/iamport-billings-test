# 결제기능

## 아임포트 정기결제 테스트
- 회사 결제 시스템 도입을 위한 테스트
- 간단하게 구현해보고, 실제 개발로 
- 
### 1. 사용스택

- nodejs(express)
- react
- iamport API

### 2. 결제로직

- 이니시스 결제를 사용했다.
- 아임포트에 따르면 이니시스 일바결제창을 사용할 경우 아래와 같은 장/단점이 있다.
```
이 방식은 다음과 같은 특징이 있습니다.
장점: 카드정보가 서버 또는 아임포트의 서버를 거치지 않고 직접 PG사로 전달되기 때문에 데이터 및 통신구간 암호화 등의 추가 보안 프로세스가 없다.
단점: PG사의 일반결제창을 통해 카드정보를 입력받기 때문에 웹브라우저를 통해서만 빌링키 발급이 이루어지며, 카드정보 입력란을 커스터마이징 할 수 없다.
```
- 결정적인 이유는 개인카드정보를 안전하게 저장/관리할 인력도, 자신도 없었기 때문이다. 행정팀과 논의하며 현재 있는 회사의 역량 내에서 할 수 있는 방향으로 선택.
- 이니시스 경우 첫결제에 빌링키를 발급해준다. 이 빌링키를 통해 정기결제가 예약되고 이루어진다
```
구독형 정기결제, 종량제 과금결제 등 원하는 시점에 재결제를 진행할 수 있는 결제용 암호화 키 입니다.
가맹점이 고객의 카드정보를 소유할 수 없기 때문에 카드사로부터 해당 카드에 대응하는 빌링키 발급 받아 저장하고,
원하는 시점에 해당 빌링키로 결제를 청구할 수 있습니다. 
```
- 문제는 이 빌링키 결제금액이 0원이 아닐경우 실제 결제된 것처럼 결과가 넘어온다. (실제 아임포트 문서에서도 0원이라고 설정하라고 되어있었음, 지금은 없네?)
- 예약결제를 위해서는 아임포트에서 Webhook을 등록해야되는데, 이 웹훅을  통해 예약된 결제가 이루어진다.
- 위에서 빌링키 발급시 실제 결제된 것처럼 결과가 넘어온다는건, 실제 금액은 빠져나가지 않지만 결제가 이루어진것처럼 결제 예약이 된다.
- 그렇게되면, 다음달부터 2개의 결제가 이루어지게되는 문제가 발생. 또한 실제 결제와 같은 결과로 넘어오기 때문에 따로 필터링을 해주지 않으면 빌링키 발급용 결제결과도 DB에 결제 정보가 저장될 수 있다.
- 그럼 빌링키 발급 결제를 0원으로하면 되는것 아닌가? 그러면 이용자가 결제를 누르면 0원으로 나타나기 때문에 결제과정에서 혼란을 초래할 수 있다.
- 아임포트 문의 결과는 0원이 아니여도 예약결제를 할 수 있다는건데, 그 방식은 조건을 통해 현재 결제가 빌링키 발급용 결제라는 것을 인지하게 해줘야 한다.
- 그래서 빌링키 발급시 merchant_uid or name을 빌링키 발급용이라는 것을 기입해서, 결제 중간에 필터를 걸어줘서 첫 결제시 2번 예약되는 문제 해결.
- 그래야 DB관리, 예약관리에 문제가 생기지 않는다.(생길수도 있지만...? 생긴다면 그때 또 해결하는 걸로)

```md
결제 -> (POST /subscribe/payments/again)-> Webhook -> 빌링키 발급
빌링키 발급되면 실제결제(파는 상품 결제, 실제 돈이 나가는 결제)가 진행 -> POST /subscribe/payments/again -> webbook
(결제 완료되면) 결제 정보 저장
다음 결제 예약

+ 중간중간 실패에 대한 에러 처리를 해줘야함/ 카드사용기간 만료, 카드 금액부족 등
```

### 3. 취소로직

```md
결제 취소의 경우 customer_uid가 필요
/subscribe/payments/unschedule/{customer_uid}
```
- 사용자는 원하는 시점에 예약된 결제를 취소할 수 있어야 한다.
- 프로필 페이지에서 본인의 결제 정보와 언제까지 사용가능한지, 그리고 결제 취소 버튼을 만들어 놓자
- 결제를 취소할 경우 환불이 이루어지는 구조는 아니다. 다음달 예약된 결제가 취소되는 것
- 
- 버튼을 누르면, 결제된 리스트를 확인한다.
- 일단 취소 신청이 된게 있는지 확인
- 취소 신청이 된게 있으면 오늘날짜와 다음 결제 날짜를 비교
- 그리고 다음 결제 날짜가 오늘 날짜륿 넘어가면 ? 권한을 바꿔줌 + 권한 처리된 날짜를 기록
- 편한건 서버가 자동으로 처리되길 원하지만, 일단 위험이 있으니까 하넙ㄴ 거쳐가는걸로
- 그 뒤로는 고객관리 영역. 고객 가입 및 탈퇴 날의 흐름을 파악해서 서비스를 제공할 수 있을거라 생각된다.
- 뭐 예를들면, 이달의 결제 멤버 수 + 이달의 취소멤버 수 => 일종의 데쉬보드 같은거지

### 4. 출처

[연동메뉴얼](https://docs.iamport.kr/)
[아임포트 API](https://api.iamport.kr/)
